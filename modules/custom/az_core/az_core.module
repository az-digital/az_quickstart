<?php

/**
 * @file
 * Contains az_core.module.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Language\LanguageInterface;
use Drupal\Core\Render\BubbleableMetadata;

/**
 * Implements hook_help().
 */
function az_core_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the az_core module.
    case 'help.page.az_core':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Settings and configuration common to other Quickstart componenets..') . '</p>';
      return $output;

    default:
  }
}

/**
 * Implements hook_pathauto_pattern_alter().
 *
 * Define and configure default url path patterns.
 * Provide a fallback if the current node pattern generated nothing.
 */
function az_core_pathauto_pattern_alter(\Drupal\pathauto\PathautoPatternInterface $pattern, array $context) {
  // Only create fallback if we're using the predefined AZQS pattern.
  $azqs_pattern = '[node:menu-link:parents:join-path]/[node:menu-link]';

  // Run a test of token replacement for the pattern to see if it is empty.
  if (isset($context['module']) && $context['module'] == 'node' && $pattern->getPattern() == $azqs_pattern) {
    $langcode = $context['language'];
    if (!isset ($langcode) || $langcode == LanguageInterface::LANGCODE_NOT_APPLICABLE) {
      $langcode = LanguageInterface::LANGCODE_NOT_SPECIFIED;
    }

    $alias = \Drupal::service('token')->replace($pattern->getPattern(), $context['data'], [
      'clear' => TRUE,
      'callback' => \Drupal::service('pathauto.alias_cleaner')->cleanAlias,
      'langcode' => $langcode,
      'pathauto' => TRUE,
    ], new BubbleableMetadata());

    // Trim leading or trailing separators.
    $alias = \Drupal::service('pathauto.alias_cleaner')->cleanAlias($alias);

    // If the pattern generated nothing, fallback on the node title pattern.
    if (empty($alias) || $alias == '/') {
      $pattern->setPattern('[node:title]');
    }
  }
}
