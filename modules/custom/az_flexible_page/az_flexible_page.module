<?php

/**
 * @file
 * Contains az_flexible_page.module.
 */

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Entity\EntityFormInterface;

/**
 * Implements hook_preprocess_node().
 */
function az_flexible_page_preprocess_node__az_flexible_page(&$variables) {
  $variables['#attached']['library'][] = 'az_flexible_page/az_flexible_page_theme';
}

/**
 * Implements hook_preprocess_HOOK() for flexible page nodes.
 */
function az_flexible_page_preprocess_page__node__az_flexible_page(&$variables) {
  // Exit if AZ Marketing Campaign pages are not enabled on the site.
  if (!(\Drupal::config('az_core.settings')->get('marketing_page_styles.enabled'))) {
    return;
  }

  $node = $variables['node'];
  $marketing_page_style = $node->get('field_az_marketing_page_style')->getString();

  if (!isset($marketing_page_style) || $marketing_page_style === '' || $marketing_page_style === '0') {
    return;
  }

  // Regions disabled by all Marketing Campaign page styles.
  if ($variables['page']['header_ua_utilities']) {
    unset($variables['page']['header_ua_utilities']);
  }
  if ($variables['page']['header']) {
    unset($variables['page']['header']);
  }
  if ($variables['page']['header_2']) {
    unset($variables['page']['header_2']);
  }
  if ($variables['page']['navigation']) {
    unset($variables['page']['navigation']);
  }
  if ($variables['page']['navigation_offcanvas']) {
    unset($variables['page']['navigation_offcanvas']);
  }
  if ($variables['page']['content_featured']) {
    unset($variables['page']['content_featured']);
  }
  if ($variables['page']['highlighted']) {
    unset($variables['page']['highlighted']);
  }
  if ($variables['page']['breadcrumb']) {
    unset($variables['page']['breadcrumb']);
  }
  if ($variables['page']['content_top']) {
    unset($variables['page']['content_top']);
  }

  // Set the navbar_offcanvas flag to FALSE since that region is disabled.
  $variables['az_barrio_navbar_offcanvas'] = FALSE;

  // Disable footer_sub regions on Standard style only.
  if ($marketing_page_style === '1') {
    if ($variables['page']['footer_sub']) {
      unset($variables['page']['footer_sub']);
    }
    if ($variables['page']['footer_sub_menus']) {
      unset($variables['page']['footer_sub_menus']);
    }
  }
}

/**
 * Implements hook_form_BASE_FORM_ID_alter() for \Drupal\node\NodeForm.
 */
function az_flexible_page_form_node_form_alter(&$form, FormStateInterface $form_state) {
  $form_object = $form_state->getFormObject();
  if ($form_object instanceof EntityFormInterface) {
    /** @var \Drupal\node\NodeInterface $node */
    $node = $form_object->getEntity();
    if (!in_array($node->bundle(), ['az_flexible_page'])) {
      return;
    }

    $form['#attached']['library'][] = 'az_flexible_page/az_flexible_page_form';

    // Remove field for Marketing Campaign Page styles if they aren't globally enabled
    // or if the user does not have permission to use them.
    if (!(\Drupal::config('az_core.settings')->get('marketing_page_styles.enabled')) ||
      !(\Drupal::currentUser()->hasPermission('use marketing campaign page styles'))) {
      $form['field_az_marketing_page_style']['#access'] = FALSE;
    }

    // $form['actions']['submit']['#submit'][] = 'az_flexible_page_process_marketing_page_setting';
  }
}
