<?php

/**
 * @file
 * Contains az_gdpr_consent.module.
 *
 * Provides geolocation-based GDPR cookie consent management.
 */

use Drupal\Core\Render\Markup;
use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function az_gdpr_consent_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.az_gdpr_consent':
      $output = '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t("The Quickstart GDPR Consent Management module provides geolocation-based cookie consent management. It uses Pantheon's AGCDN geolocation headers (X-Geo-Country-Code) to detect visitor location server-side and conditionally shows the Klaro consent banner only for visitors from countries that require GDPR compliance or have similar data protection laws.") . '</p>';
      $output .= '<p>' . t('For non-GDPR countries (like the United States), the module automatically pre-sets consent for all services before Klaro loads, allowing tracking to work as if Klaro was not installed.') . '</p>';
      $output .= '<h3>' . t('Configuration') . '</h3>';
      $output .= '<p>' . t('Configure the module at Administration » Configuration » Arizona Quickstart » Arizona Quickstart Settings » Quickstart GDPR Consent Management.') . '</p>';
      $output .= '<h3>' . t('Caching') . '</h3>';
      $output .= '<p>' . t('The module uses Drupal cache contexts to vary the cached page by country code. This ensures that visitors from different countries receive the appropriate cached version (with or without consent pre-set).') . '</p>';
      return $output;
  }
}

/**
 * Implements hook_page_attachments().
 *
 * Attaches geolocation-based consent logic using server-side detection.
 */
function az_gdpr_consent_page_attachments(array &$attachments) {
  // Don't run on admin routes.
  if (\Drupal::service('router.admin_context')->isAdminRoute()) {
    return;
  }

  $config = \Drupal::config('az_gdpr_consent.settings');

  // Don't run if module is disabled.
  if (!$config->get('enabled')) {
    return;
  }

  // Add cache context for geolocation header.
  // This automatically adds Vary: X-Geo-Country-Code to the response.
  $attachments['#cache']['contexts'][] = 'headers:X-Geo-Country-Code';

  // Get country code from Pantheon AGCDN header.
  $country_code = $_SERVER['HTTP_X_GEO_COUNTRY_CODE'] ?? NULL;

  // Override in test mode.
  if ($config->get('test_mode')) {
    $country_code = $config->get('test_country_code') ?? 'US';
  }

  // Get GDPR country list from configuration.
  $gdpr_countries = $config->get('target_countries') ?? [];

  // Determine if this is a GDPR country.
  $is_gdpr_country = $country_code && in_array(strtoupper($country_code), array_map('strtoupper', $gdpr_countries));

  // Fallback for unknown location.
  if (!$country_code) {
    $is_gdpr_country = $config->get('show_on_unknown_location') ?? FALSE;
  }

  // For non-GDPR countries: Pre-set Klaro consent via inline JavaScript.
  if (!$is_gdpr_country) {
    // Get configured Klaro services.
    $klaro_config = \Drupal::config('klaro.settings');
    $klaro_helper = \Drupal::service('klaro.helper');
    $services = [];

    // Get all configured services from Klaro.
    if ($klaro_helper) {
      $apps = $klaro_helper->getApps();
      foreach ($apps as $app) {
        $services[] = $app->id();
      }
    }

    // Build consent object.
    $consents = [];
    foreach ($services as $service) {
      $consents[$service] = TRUE;
    }

    // Get Klaro storage settings.
    $storage_method = $klaro_config->get('library.storage_method') ?? 'cookie';
    $storage_name = $klaro_config->get('library.cookie_name') ?? 'klaro';
    $cookie_expires = $klaro_config->get('library.cookie_expires_after_days') ?? 180;

    // Create inline JavaScript to pre-set consent before Klaro loads.
    $consents_json = json_encode($consents);

    $inline_js = <<<JS
(function() {
  try {
    // Pre-set Klaro consent for all services (non-GDPR country).
    var consents = $consents_json;
    var storageName = '$storage_name';
    var storageMethod = '$storage_method';
    var consentsJson = JSON.stringify(consents);

    if (storageMethod === 'cookie') {
      // Set cookie with expiration
      var expiryDays = $cookie_expires;
      var expiryDate = new Date();
      expiryDate.setTime(expiryDate.getTime() + (expiryDays * 24 * 60 * 60 * 1000));
      var expires = 'expires=' + expiryDate.toUTCString();
      document.cookie = storageName + '=' + encodeURIComponent(consentsJson) + ';' + expires + ';path=/;SameSite=Lax';

      if (console && console.log) {
        console.log('[AZ GDPR Consent] Auto-accepted all services (cookie) for non-GDPR country: $country_code');
      }
    } else {
      // Use localStorage
      localStorage.setItem(storageName, consentsJson);

      if (console && console.log) {
        console.log('[AZ GDPR Consent] Auto-accepted all services (localStorage) for non-GDPR country: $country_code');
      }
    }
  } catch(e) {
    if (console && console.error) {
      console.error('[AZ GDPR Consent] Error auto-accepting services:', e);
    }
  }
})();
JS;

    $attachments['#attached']['html_head'][] = [
      [
        '#type' => 'html_tag',
        '#tag' => 'script',
        '#value' => Markup::create($inline_js),
        '#weight' => -1000,
      ],
      'az_gdpr_consent_auto_accept',
    ];
  }
}
